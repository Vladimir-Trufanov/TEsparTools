## [TQue -  Обеспечить передачу и приём сообщений "как есть", максимум 1023 символа, плюс завершающий ноль, через очередь в задачах и из прерываний](#) v1.0.0, 23.12.2024 

Класс ***TQue*** предназначен для организации единообразной передачи простых сообщений "как есть", максимум 1023 символа, плюс завершающий ноль в последовательный порт или на другую периферию. 

---

### [Внешняя функция пeредачи сообщения на периферию](#%D0%B2%D0%BD%D0%B5%D1%88%D0%BD%D1%8F%D1%8F-%D1%84%D1%83%D0%BD%D0%BA%D1%86%D0%B8%D1%8F-%D0%BF%D0%B5%D1%80%D0%B5%D0%B4%D0%B0%D1%87%D0%B8-%D1%81%D0%BE%D0%BE%D0%B1%D1%89%D0%B5%D0%BD%D0%B8%D1%8F-%D0%BD%D0%B0-%D0%BF%D0%B5%D1%80%D0%B8%D1%84%D0%B5%D1%80%D0%B8%D1%8E)

### [Подготoвка передачи сообщений в приложении через очередь](#%D0%BF%D0%BE%D0%B4%D0%B3%D0%BE%D1%82%D0%BE%D0%B2%D0%BA%D0%B0-%D0%BF%D0%B5%D1%80%D0%B5%D0%B4%D0%B0%D1%87%D0%B8-%D1%81%D0%BE%D0%BE%D0%B1%D1%89%D0%B5%D0%BD%D0%B8%D0%B9-%D0%B2-%D0%BF%D1%80%D0%B8%D0%BB%D0%BE%D0%B6%D0%B5%D0%BD%D0%B8%D0%B8-%D1%87%D0%B5%D1%80%D0%B5%D0%B7-%D0%BE%D1%87%D0%B5%D1%80%D0%B5%D0%B4%D1%8C)

### [Мeтоды класса TQue](#%D0%BC%D0%B5%D1%82%D0%BE%D0%B4%D1%8B-%D0%BA%D0%BB%D0%B0%D1%81%D1%81%D0%B0-tque)

---

### Внешняя функция передачи сообщения на периферию

Направление передачи информации определяется во внешней функции ***transQue***, которая может быть изменена пользователем. 

Функции передаются указатели на два массива символов с завершающим нулём: ***mess*** - собственно сообщение, которое прошло через очередь, и ***prefix*** - префикс сообщения (по умолчанию отсутствует).
```
// Передатчик сообщения на периферию с возможным префиксом (по умолчанию):
inline void transQue(char *mess, char *prefix="") 
{
   // Выводим массивы символов с 0-вым окончанием
   Serial.print(prefix);  // передали префикс (по умолчанию отсутствует)
   Serial.println(mess);  // передали сообщение
}
```
Префикс сообщения, это краткий фрагмент текста, который выводится перед сообщением. Назначение или смысл префикса определяются разработчиком приложения.

```
// Выбираем из очереди и отправляем сообщение на периферию
#ifdef tmr_QUEUERELEASE
     queMessa.PostAll();
#else
     queMessa.Post("Hello: ");
#endif
```
### Подготовка передачи сообщений в приложении через очередь

Для запуска передачи сообщений в приложении через очередь нужно выполнить следующие действия:

- подключить к приложению библиотеку QueMess.h;
- при необходимости сделать свой передатчик сообщений вместо установленного в классе передатчика по умолчанию "transQue";
- назначить указатель объекта работы с сообщениями через очередь TQueMessage с указанием размера очереди или оставить по умолчанию 4
```
// ============================================== 1. Инициировать использование очереди ===
// Подключаем файлы обеспечения передачи и приёма сообщений через очередь                //
#include "QueChar.h"     // заголовочный файл класса TQueMessage                         //
// Назначаем объект работы с сообщениями через очередь                                   //
TQue queMessa(8);                                                                        //
// ========================================================================================                                                                                         
``` 

- в функции Setup создать очередь и подключить функцию передачи сообщения на периферию 
```
   // ====================================== 2. Создать очередь и подключить передатчик ===
   // Создаем очередь                                                                    //
   String inMess=queMessa.Create();                                                      //
   // Если не получилось, сообщаем "Очередь не была создана и не может использоваться"   // 
   if (inMess==tQueueNotCreate) Serial.println(tQueueNotCreate);                         //
   // Если очередь получилась, то отмечаем  "Очередь сформирована"                       //
   else Serial.println(tQueueBeformed);                                                  //
   // Подключаем функцию передачи сообщения на периферию                                 //
   queMessa.attachFunction(transQue);                                                    //
   // ===================================================================================== 
```
###### [к содержанию](#%D0%B2%D0%BD%D0%B5%D1%88%D0%BD%D1%8F%D1%8F-%D1%84%D1%83%D0%BD%D0%BA%D1%86%D0%B8%D1%8F-%D0%BFe%D1%80%D0%B5%D0%B4%D0%B0%D1%87%D0%B8-%D1%81%D0%BE%D0%BE%D0%B1%D1%89%D0%B5%D0%BD%D0%B8%D1%8F-%D0%BD%D0%B0-%D0%BF%D0%B5%D1%80%D0%B8%D1%84%D0%B5%D1%80%D0%B8%D1%8E)

### Методы класса TQue

- ***Построить объект (конструктор класса)***. 

При определении в приложении переменной для объекта класса (то есть при вызове конструктора класса) можно указать максимальное количество сообщений, которое может быть помещено в очередь, по умолчанию 4 сообщения.

Формат:

```
TQue(int iQueueSize=4);

// iQueueSize - количество элементов очереди (по умолчанию 4)
```

- ***Создать очередь***

При вызове данного метода резервируется пространство в оперативной памяти для размещения сообщений очереди.

Формат:
```
String Create();
```
Если функции не удалось создать очередь, то она вернет строку ***tQueueNotCreate*** =  "***Очередь не была создана и не может использоваться***". Если все хорошо, то возвращается ***isOk***.

- ***Отправить сообщение из задачи или из прерывания*** 

```
// Отправить сообщение из задачи
String Send(String Source); 
// Отправить сообщение из прерывания
String SendISR(String Source);
```
Через параметр ***Source*** передается в очередь текст сообщения.

- ***Подключить внешнюю функцию передачи сообщения на периферию***

```
void attachFunction(void (*function)(char *mess, char *prefix));
```

- ***Выбрать сообщение из очереди***

Если к моменту выборки сообщения из очереди, очередь не пуста и в ней находятся несколько сообщений, то выбирается из очереди ***одно сообщение***.

Если выбрать элемент из очереди без ошибки не удалось, то возвращается сообщение вне формата ***ErrorReceiving*** = "***Ошибка при приёме сообщения из очереди***".

При выборке из очереди может еще быть получено несколько сообщений вне формата:

если очередь не создана, то методом возвращается сообщение ***NoQueueReceive*** = "***Прием сообщения: очередь структур не создана***". Если в очереди нет сообщений, то возвращается сообщение ***QueueEmptyReceive***  = "***Очередь пуста при приёме сообщения***". 

Все сообщения возвращаются методом, как массив до 1023 символов с завершающим нулём.

Формат:
```
char* Receive();
```
- ***Выбрать сообщение из очереди и отправить на периферию***

Существуют два метода, которые выбирают сообщения из очереди и сразу используют внешнюю функцию для отправки сообщения на периферию. Метод ***Post*** выбирает одно сообщение, а метод ***PostAll*** выбирает сразу все сообщения, которые к моменту накопились в очереди.
```
// Выбрать сообщение из очереди и отправить на периферию 
char* Post(char *prefix="");
// Выбрать все сообщения разом из очереди и отправить на периферию
void PostAll(char *prefix="");
```
- ***Определить количество свободных мест в очереди***
```
int How_many_free();
```
- ***Определить, сколько сообщений накопилось в очереди и их можно выгрузить***
```
int How_many_wait(); 
```
###### [к содержанию](#%D0%B2%D0%BD%D0%B5%D1%88%D0%BD%D1%8F%D1%8F-%D1%84%D1%83%D0%BD%D0%BA%D1%86%D0%B8%D1%8F-%D0%BFe%D1%80%D0%B5%D0%B4%D0%B0%D1%87%D0%B8-%D1%81%D0%BE%D0%BE%D0%B1%D1%89%D0%B5%D0%BD%D0%B8%D1%8F-%D0%BD%D0%B0-%D0%BF%D0%B5%D1%80%D0%B8%D1%84%D0%B5%D1%80%D0%B8%D1%8E)
